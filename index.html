<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AVI-ABSENSI PRO</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
      // Import Firebase dari CDN
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        doc,
        onSnapshot,
        addDoc,
        updateDoc,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // Konfigurasi - Ganti dengan data Anda
      const firebaseConfig = {
        apiKey: "AIzaSyDYcihqDIHiGfXUzOYPw8-gSDHPgjwefgc",
        authDomain: "avi-absensi.firebaseapp.com",
        projectId: "avi-absensi",
        storageBucket: "avi-absensi.firebasestorage.app",
        messagingSenderId: "1051993532328",
        appId: "1:1051993532328:web:5bcf3b8b80eb842b0ddf9d",
        measurementId: "G-4Y2C2E6FJ9",
      };

      // Jika Anda menggunakan Vercel Env, logika di bawah ini akan mencoba mengambilnya
      // Namun untuk Single File HTML, Anda disarankan langsung menempelnya di atas atau menggunakan window.env

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const appId = "avi-absensi-v1";

      const { useState, useEffect, useMemo } = React;

      function App() {
        const [user, setUser] = useState(null);
        const [dbUser, setDbUser] = useState(null);
        const [loginInput, setLoginInput] = useState({
          username: "",
          password: "",
        });
        const [currentPage, setCurrentPage] = useState("absen");
        const [currentTime, setCurrentTime] = useState(new Date());
        const [absensiType, setAbsensiType] = useState("Umum");
        const [logs, setLogs] = useState([]);
        const [statusMessage, setStatusMessage] = useState(null);
        const [isLoading, setIsLoading] = useState(false);
        const [activeHistoryTab, setActiveHistoryTab] = useState("Umum");
        const [filterName, setFilterName] = useState("Semua");
        const [filterMonth, setFilterMonth] = useState(new Date().getMonth());

        const UPAH_PER_JAM = 25000;
        const daftarBulan = [
          "Januari",
          "Februari",
          "Maret",
          "April",
          "Mei",
          "Juni",
          "Juli",
          "Agustus",
          "September",
          "Oktober",
          "November",
          "Desember",
        ];
        const pegawaiAkses = {
          Abub: ["Umum"],
          Rendy: ["Umum"],
          Dedi: ["Umum"],
          Vebi: ["Live"],
          Silvi: ["Umum", "Live"],
          Aisyah: ["Umum", "Live"],
        };
        const daftarPegawai = {
          Umum: ["Abub", "Dedi", "Silvi", "Aisyah", "Rendy"],
          Live: ["Silvi", "Aisyah", "Vebi"],
        };

        useEffect(() => {
          const initAuth = async () => {
            try {
              await signInAnonymously(auth);
            } catch (err) {
              console.error("Auth error", err);
            }
          };
          initAuth();
          const unsubscribe = onAuthStateChanged(auth, (u) => setDbUser(u));
          return () => unsubscribe();
        }, []);

        useEffect(() => {
          if (!dbUser) return;
          const qLogs = collection(
            db,
            "artifacts",
            appId,
            "public",
            "data",
            "absensi_logs"
          );
          return onSnapshot(qLogs, (snapshot) => {
            const data = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            setLogs(data.sort((a, b) => b.timestamp - a.timestamp));
          });
        }, [dbUser]);

        useEffect(() => {
          const timer = setInterval(() => setCurrentTime(new Date()), 1000);
          return () => clearInterval(timer);
        }, []);

        const showStatus = (msg, type) => {
          setStatusMessage({ msg, type });
          setTimeout(() => setStatusMessage(null), 3000);
        };

        const handleLogin = (e) => {
          e.preventDefault();
          const { username, password } = loginInput;
          if (username === "admin" && password === "admin123") {
            setUser({ nama: "Administrator", role: "admin" });
            return;
          }
          const found = Object.keys(pegawaiAkses).find(
            (p) => p.toLowerCase() === username.toLowerCase()
          );
          if (found && password.toLowerCase() === found.toLowerCase()) {
            setUser({ nama: found, role: "pegawai" });
          } else {
            showStatus("Login Gagal", "error");
          }
        };

        const handleAbsen = async (action) => {
          if (!dbUser || isLoading) return;
          setIsLoading(true);
          const now = new Date();
          const todayStr = now.toLocaleDateString("id-ID");

          const sudahAda = logs.find(
            (l) =>
              l.nama === user.nama &&
              l.tipe === absensiType &&
              l.aksi === action &&
              new Date(l.timestamp).toLocaleDateString("id-ID") === todayStr
          );

          if (sudahAda) {
            showStatus(`Gagal: Sudah ${action} hari ini`, "error");
            setIsLoading(false);
            return;
          }

          try {
            await addDoc(
              collection(
                db,
                "artifacts",
                appId,
                "public",
                "data",
                "absensi_logs"
              ),
              {
                nama: user.nama,
                tipe: absensiType,
                aksi: action,
                waktu: now.toLocaleTimeString("id-ID", {
                  hour: "2-digit",
                  minute: "2-digit",
                }),
                tanggalDisplay: now.toLocaleDateString("id-ID", {
                  weekday: "long",
                  day: "numeric",
                  month: "long",
                }),
                bulanIndex: now.getMonth(),
                timestamp: Date.now(),
                isEdited: false,
              }
            );
            showStatus(`Absen ${action} Berhasil`, "success");
          } catch (e) {
            showStatus("Koneksi Error", "error");
          }
          setIsLoading(false);
        };

        // Render Logic (Sama seperti versi sebelumnya namun dalam satu file)
        if (!user) {
          return (
            <div className="min-h-screen flex items-center justify-center p-6 bg-slate-100">
              <div className="w-full max-w-md bg-white rounded-[2.5rem] shadow-2xl p-10 text-center">
                <h1 className="text-2xl font-black text-blue-600 mb-6 uppercase">
                  AVI-ABSENSI
                </h1>
                <form onSubmit={handleLogin} className="space-y-4 text-left">
                  <input
                    type="text"
                    placeholder="Username"
                    className="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold"
                    value={loginInput.username}
                    onChange={(e) =>
                      setLoginInput({ ...loginInput, username: e.target.value })
                    }
                  />
                  <input
                    type="password"
                    placeholder="Password"
                    className="w-full p-4 bg-gray-50 rounded-2xl outline-none font-bold"
                    value={loginInput.password}
                    onChange={(e) =>
                      setLoginInput({ ...loginInput, password: e.target.value })
                    }
                  />
                  <button className="w-full bg-blue-600 text-white p-4 rounded-2xl font-black uppercase text-xs shadow-lg">
                    Masuk
                  </button>
                </form>
              </div>
            </div>
          );
        }

        return (
          <div className="min-h-screen bg-[#F8FAFC] p-4 pb-32 max-w-md mx-auto relative">
            {/* Header */}
            <div className="flex justify-between items-center py-6">
              <h1 className="text-xl font-black text-blue-600">AVI-ABSENSI</h1>
              <button
                onClick={() => setUser(null)}
                className="p-2 text-rose-500 bg-white rounded-xl shadow-sm border border-gray-100 font-bold text-xs uppercase"
              >
                Logout
              </button>
            </div>

            {/* Content */}
            {currentPage === "absen" ? (
              <div className="space-y-6">
                <div className="bg-white rounded-3xl p-8 shadow-xl text-center border border-gray-100">
                  <h2 className="text-5xl font-black text-gray-800 tracking-tighter">
                    {currentTime.toLocaleTimeString("id-ID", {
                      hour: "2-digit",
                      minute: "2-digit",
                    })}
                  </h2>
                  <p className="text-blue-600 font-bold uppercase text-[10px] tracking-widest">
                    {currentTime.toLocaleDateString("id-ID", {
                      weekday: "long",
                      day: "numeric",
                      month: "long",
                    })}
                  </p>
                </div>

                <div className="bg-white rounded-3xl p-6 shadow-xl space-y-4">
                  <div className="flex p-1 bg-gray-100 rounded-2xl">
                    <button
                      onClick={() => setAbsensiType("Umum")}
                      className={`flex-1 py-3 rounded-xl font-black text-[10px] uppercase ${
                        absensiType === "Umum"
                          ? "bg-white shadow-sm"
                          : "text-gray-400"
                      }`}
                    >
                      Umum
                    </button>
                    <button
                      onClick={() => setAbsensiType("Live")}
                      className={`flex-1 py-3 rounded-xl font-black text-[10px] uppercase ${
                        absensiType === "Live"
                          ? "bg-white shadow-sm"
                          : "text-gray-400"
                      }`}
                    >
                      Live
                    </button>
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <button
                      onClick={() => handleAbsen("Masuk")}
                      className="bg-emerald-500 text-white p-6 rounded-3xl font-black text-[10px] uppercase shadow-lg active:scale-95"
                    >
                      Masuk
                    </button>
                    <button
                      onClick={() => handleAbsen("Pulang")}
                      className="bg-rose-500 text-white p-6 rounded-3xl font-black text-[10px] uppercase shadow-lg active:scale-95"
                    >
                      Pulang
                    </button>
                  </div>
                </div>
              </div>
            ) : (
              <div className="bg-white rounded-[2rem] shadow-xl overflow-hidden divide-y divide-gray-50 border border-gray-100">
                {logs.map((log) => (
                  <div
                    key={log.id}
                    className="p-4 flex justify-between items-center"
                  >
                    <div>
                      <p className="font-black text-xs text-gray-800">
                        {log.nama}
                      </p>
                      <p className="text-[8px] text-gray-400 uppercase font-black">
                        {log.tanggalDisplay}
                      </p>
                    </div>
                    <div className="text-right">
                      <p className="text-xs font-black text-gray-800">
                        {log.waktu}
                      </p>
                      <p
                        className={`text-[8px] font-black uppercase ${
                          log.aksi === "Masuk"
                            ? "text-emerald-500"
                            : "text-rose-500"
                        }`}
                      >
                        {log.aksi}
                      </p>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* Bottom Nav */}
            <div className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md bg-white border shadow-2xl rounded-[2.5rem] p-2 flex justify-around">
              <button
                onClick={() => setCurrentPage("absen")}
                className={`flex-1 py-3 rounded-[2rem] text-[8px] font-black uppercase ${
                  currentPage === "absen"
                    ? "bg-blue-600 text-white"
                    : "text-gray-400"
                }`}
              >
                Absen
              </button>
              <button
                onClick={() => setCurrentPage("history")}
                className={`flex-1 py-3 rounded-[2rem] text-[8px] font-black uppercase ${
                  currentPage === "history"
                    ? "bg-blue-600 text-white"
                    : "text-gray-400"
                }`}
              >
                Audit
              </button>
            </div>

            {/* Status Pop */}
            {statusMessage && (
              <div className="fixed top-10 left-1/2 -translate-x-1/2 px-6 py-2 bg-gray-900 text-white rounded-full text-[10px] font-black uppercase tracking-widest z-50 animate-bounce">
                {statusMessage.msg}
              </div>
            )}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
